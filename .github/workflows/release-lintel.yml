# Release workflow for the lintel CLI binary.
# Triggered via workflow_dispatch by release-plz or manually.
#
# Binary builds are handled by build.yml (push trigger) which auto-detects
# the release and uploads assets. This workflow waits for those assets,
# then publishes to NPM and pushes multi-arch Docker images to GHCR.

name: Release Lintel

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.0.7)"
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Check ref is a version tag
        run: |
          if [[ ! "${{ github.ref }}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::This workflow must be run on a vX.Y.Z tag (via --ref), got ${{ github.ref }}"
            exit 1
          fi

      - name: Ensure release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release view v${{ inputs.version }} --repo ${{ github.repository }} >/dev/null 2>&1 || \
            gh release create v${{ inputs.version }} --repo ${{ github.repository }} --generate-notes

  npm:
    name: Publish to NPM
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Wait for release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ inputs.version }}"
          EXPECTED=7
          for i in $(seq 1 60); do
            COUNT=$(gh release view "$TAG" --json assets \
              --jq '[.assets[] | select(.name | startswith("lintel-"))] | length')
            if [ "$COUNT" -ge "$EXPECTED" ]; then
              echo "All $COUNT assets available"
              exit 0
            fi
            echo "Waiting for release assets ($COUNT/$EXPECTED, attempt $i/60)..."
            sleep 30
          done
          echo "::error::Timed out waiting for release assets (got $COUNT, expected $EXPECTED)"
          exit 1
      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p artifacts
          gh release download "v${{ inputs.version }}" --dir artifacts --pattern 'lintel-*'
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "workspace"
      - uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
      - name: Generate and publish npm packages
        run: |
          cargo run --release --package npm-release-binaries -- release \
            --package lintel \
            --release-version ${{ inputs.version }} \
            --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  action:
    name: Update lintel-rs/action tags
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Update version tags on lintel-rs/action
        env:
          GH_TOKEN: ${{ secrets.ACTION_RELEASE_TOKEN }}
        run: |
          VERSION="v${{ inputs.version }}"
          MAJOR="v$(echo "${{ inputs.version }}" | cut -d. -f1)"
          HEAD=$(gh api repos/lintel-rs/action/git/ref/heads/master --jq .object.sha)

          # Create vX.Y.Z tag
          gh api repos/lintel-rs/action/git/refs \
            -X POST -f ref="refs/tags/${VERSION}" -f sha="$HEAD"

          # Update vX tag
          gh api repos/lintel-rs/action/git/refs/tags/${MAJOR} \
            -X PATCH -f sha="$HEAD" -F force=true 2>/dev/null \
          || gh api repos/lintel-rs/action/git/refs \
            -X POST -f ref="refs/tags/${MAJOR}" -f sha="$HEAD"

  docker-build:
    name: Docker (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
      - uses: cachix/cachix-action@v16
        with:
          name: lintel
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build image with Nix
        run: nix build .#docker

      - name: Load image
        run: docker load < result

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push
        run: |
          ARCH_TAG=${{ inputs.version }}-${{ matrix.arch }}

          docker tag ghcr.io/lintel-rs/lintel:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ARCH_TAG}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ARCH_TAG}

  docker-manifest:
    name: Docker Manifest
    needs: docker-build
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifests
        run: |
          VERSION=${{ inputs.version }}
          MAJOR_MINOR=${VERSION%.*}
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

          TAGS=("${VERSION}" "latest")
          if [[ "${MAJOR_MINOR}" != "${VERSION}" ]]; then
            TAGS+=("${MAJOR_MINOR}")
          fi

          for TAG in "${TAGS[@]}"; do
            docker manifest create ${IMAGE}:${TAG} \
              ${IMAGE}:${VERSION}-amd64 \
              ${IMAGE}:${VERSION}-arm64
            docker manifest push ${IMAGE}:${TAG}
          done
