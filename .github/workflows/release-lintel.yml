# Release workflow for the lintel CLI binary.
# Triggered via workflow_dispatch by release-plz or manually.
#
# Builds native binaries (nix + cargo), creates a GitHub release,
# publishes to NPM, and pushes multi-arch Docker images to GHCR.

name: Release Lintel

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.0.7)"
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Check ref is a version tag
        run: |
          if [[ ! "${{ github.ref }}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::This workflow must be run on a vX.Y.Z tag (via --ref), got ${{ github.ref }}"
            exit 1
          fi

  build-nix:
    name: Build (${{ matrix.target }})
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-15-intel
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
      - uses: cachix/cachix-action@v16
        with:
          name: lintel
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build
        run: nix build

      - name: Package
        run: tar czf lintel-${{ matrix.target }}.tar.gz -C result/bin lintel

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lintel-${{ matrix.target }}
          path: lintel-${{ matrix.target }}.tar.gz

  build-cargo:
    name: Build (${{ matrix.target }})
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "workspace"

      - name: Install cross-compilation tools (aarch64 musl)
        if: matrix.target == 'aarch64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          wget -q https://musl.cc/aarch64-linux-musl-cross.tgz
          tar xzf aarch64-linux-musl-cross.tgz -C /opt
          echo "/opt/aarch64-linux-musl-cross/bin" >> $GITHUB_PATH
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=aarch64-linux-musl-gcc" >> $GITHUB_ENV

      - name: Install cross-compilation tools (x86_64 musl)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Build
        run: cargo build --release --package lintel --target ${{ matrix.target }}

      - name: Package (unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../lintel-${{ matrix.target }}.tar.gz lintel

      - name: Package (windows)
        if: runner.os == 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          Compress-Archive -Path lintel.exe -DestinationPath ../../../lintel-${{ matrix.target }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lintel-${{ matrix.target }}
          path: lintel-${{ matrix.target }}.*

  release:
    name: Create Release
    needs: [build-nix, build-cargo]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          files: lintel-*
          generate_release_notes: true

  npm:
    name: Publish to NPM
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: artifacts
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "workspace"
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
      - name: Generate and publish npm packages
        run: |
          cargo run --release --package npm-release-binaries -- release \
            --package lintel \
            --release-version ${{ inputs.version }} \
            --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  docker-build:
    name: Docker (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
      - uses: cachix/cachix-action@v16
        with:
          name: lintel
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build image with Nix
        run: nix build .#docker

      - name: Load image
        run: docker load < result

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push
        run: |
          ARCH_TAG=${{ inputs.version }}-${{ matrix.arch }}

          docker tag ghcr.io/lintel-rs/lintel:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ARCH_TAG}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ARCH_TAG}

  docker-manifest:
    name: Docker Manifest
    needs: docker-build
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifests
        run: |
          VERSION=${{ inputs.version }}
          MAJOR_MINOR=${VERSION%.*}
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

          TAGS=("${VERSION}" "latest")
          if [[ "${MAJOR_MINOR}" != "${VERSION}" ]]; then
            TAGS+=("${MAJOR_MINOR}")
          fi

          for TAG in "${TAGS[@]}"; do
            docker manifest create ${IMAGE}:${TAG} \
              ${IMAGE}:${VERSION}-amd64 \
              ${IMAGE}:${VERSION}-arm64
            docker manifest push ${IMAGE}:${TAG}
          done
